KISSY.add("tbc/search-suggest/6.3.1/mods/local-query",["base","json","tbc/search-suggest/6.3.1/mods/storage"],function(t,e,n,a){function s(t){s.superclass.constructor.call(this,t||{}),this.initialize()}var i=e("base"),r=(e("json"),e("tbc/search-suggest/6.3.1/mods/storage")),o="suggest_history_",u=7,c=100;KISSY.extend(s,i,{initialize:function(){var t=this,e=t.get("name"),n=t.get("tab"),a=t.get("user");"item"===n&&(n="baobei"),t.storageKey=o+e+n+a,t._initStorage(),t.loadHistory()},_setKey:function(t){var e=this,n=t.name||e.get("name"),a=t.tab||e.get("tab"),s=t.user||e.get("user");"item"===a&&(a="baobei"),e.storageKey=o+n+a+s,e.set("tab",a),e.set("name",n),e.set("user",s)},_initStorage:function(){var t=this.get("storageType");switch(t){case"flashStorage":KISSY.log("`storageType=flashStorage`, flash 已下线，使用 iframe localStorage 支持"),this.storage=this._initFlashStorage();break;default:this.storage=this._initIframeStraoge()}},_initFlashStorage:function(){return this._initIframeStraoge()},_initIframeStraoge:function(){var t=this;return{save:function(){return(new r).writeAsync(t.storageKey,t.getDataList())},read:function(){return(new r).readAsync(t.storageKey)},onReady:function(){return(new r).onReady()}}},checkFlash:function(t){this.storage.onReady().then(t&&t.onSuccess,t&&t.onFailure)},loadHistory:function(){var t=this;return this.storage.read().then(function(e){t.setDataList(e),t.translateCn2Pinyin(e)})},translateCn2Pinyin:function(e){e=e||[];for(var n=[],a=0,s=e.length;s>a;a++){var i=e[a],r=/[\u4e00-\u9fa5]/,o=decodeURIComponent(i.value);r.test(o)&&n.push(o)}var u=",,,";if(n.length){this.__cnList=n,this.__cnSep=u,KISSY.suggestHistoryJSONP=t.bind(this._mergeCnPinyin,this);var c=location.protocol+"//suggest.taobao.com/sug?code=utf-8&area=py&callback=KISSY.suggestHistoryJSONP&q="+n.join(u);KISSY.getScript(c)}},_mergeCnPinyin:function(e){if(e&&e.result){var n=e.result[0]||"",a=n.split(this.__cnSep);if(this.__cnList&&a.length===this.__cnList.length){var s={},i=this;t.each(this.__cnList,function(t,e){s[i.__cnList[e]]=a[e]});for(var r=this.getDataList(),o=0,u=r.length;u>o;o++){var c=r[o],h=decodeURIComponent(c.value);s[h]&&(c.value=s[h])}this.setDataList(r)}}},purge:function(e){for(var n=[],a=t.now()-24*u*3600*1e3,s=0,i=e.length;i>s;s++){var r=e[s];r.time>a&&n.push(r)}return n.sort(function(t,e){return e.time-t.time}),n.length>c&&(n.length=c),n=this._distinctByValue(n)},getDataList:function(){var t=this._datalist||[];return t.concat()},setDataList:function(t){t=this.purge(t||[]),this._datalist=t.concat()},addTobeSavedList:function(e,n){if(!e.match(/<>'"/)&&!n.match(/<>'"/)){var a=this.getDataList(),s={key:encodeURIComponent(e),value:encodeURIComponent(n),time:t.now()};a.unshift(s),this.setDataList(a)}},_distinctByValue:function(t){for(var e,n=[],a=0,s=t.length;s>a;a++)e=t[a],e.value.match(/%3C|%3E|[<>'"]/g)||this._hasItemOfValue(n,e.value)||n.push(e);return n},_hasItemOfValue:function(t,e){for(var n=!1,a=t.length-1;a>=0;a--)t[a].value===e&&(n=!0);return n},save:function(t,e){""!==e&&(this.addTobeSavedList(t,e),this.storage.save())},query:function(e){var n=this.getDataList();if(e){e=encodeURIComponent(e);var a,s,i=[];return t.each(n,function(t){a=t.key,s=t.value,(0===a.indexOf(e)||0===s.indexOf(e))&&i.push(t)}),i}return n},deleteItem:function(t){for(var e=this.getDataList(),n=encodeURIComponent(t),a=[],s=0,i=e.length;i>s;s++){var r=e[s];r.key!=n&&a.push(r)}this.setDataList(a),this.storage.save()},destructor:function(){this._datalist=null,o=null},clearByDay:function(){},hasHistory:function(){},_query:function(t){},_deleteItemByValue:function(t,e){}},{ATTRS:{name:{value:"default",setter:function(t){return t}},user:{value:"",setter:function(t){return KISSY.fromUnicode(t)}},maxLength:{value:500},storageType:{value:"flashStorage",setter:function(t){return t},getter:function(t){return t}}}}),a.exports=s});KISSY.add("tbc/search-suggest/6.3.1/mods/menu",["node"],function(e,t,n,r){var o=t("node"),u=o.all,l=function(e){var t=this;t.opts=KISSY.mix(l.defs,e),t.$wrap=u(t.opts.wrap),t.$menu=u(t.opts.menu),t.locs=[],t.rNow=null,t.tOut=null,t.init()};l.defs={wrap:"",menu:"",rows:"",dealy:300,handler:null,tolerance:0},l.prototype.getOffset=function(){var e=this,t=e.opts,n=e.$menu,r=n.offset();e.menuOffset=r,e.upperRight={x:r.left+n.outerWidth(),y:r.top-t.tolerance},e.lowerRight={x:r.left+n.outerWidth(),y:r.top+n.outerHeight()+t.tolerance}},l.prototype.bindEvent=function(){var e,t,n,r=this,o=r.opts,l=r.locs,a=r.rNow,i=r.tOut,s=null,f=function(i){function f(e,t){return(t.y-e.y)/(t.x-e.x)}var c=!!u(i).one(o.cls);r.getOffset(),e=r.menuOffset,t=r.upperRight,n=r.lowerRight;var p=l[l.length-1],g=l[0];if(!a||!p)return 0;if(g.x<e.left||g.x>n.x||g.y<e.top||g.y>n.y)return 0;if(s&&p.x==s.x&&p.y==s.y)return 0;var d=f(p,t),h=f(p,n),y=f(g,t),m=f(g,n);return c&&y>d&&h>m?(s=p,o.dealy):(s=null,0)},c=function(e){a!=e&&(o.handler.enterHandler(e),a=e)},p=function(e,t){r.isDelay=t?!0:!1;var n=f(t);n?i=setTimeout(function(){p(r.currentTarget,r.currentTarget)},n):(r.isDelay=!1,c(e))},g=function(e){l.push({x:e.pageX,y:e.pageY}),l.length>3&&l.shift()},d=function(){a=null,o.handler.leaveHandler()},h=function(){r.isDelay=!1,a=null,i&&clearTimeout(i)},y=function(e){if(r.currentTarget=e.currentTarget,!r.isDelay){i&&clearTimeout(i);var t=e.relatedTarget,n=u(t).parent(o.rows);p(e.currentTarget,n)}};r.$wrap.on("mousemove",g).on("mouseleave",d),r.$menu.on("mouseleave",h).delegate("mouseenter",o.rows,y)},l.prototype.init=function(){this.getOffset(),this.bindEvent()},r.exports=l});KISSY.add("tbc/search-suggest/6.3.1/tpl/cloud",[],function(a,t,l,s){s.exports={navi:function(a){var t='<div id="J_CloudList'+a.prefix+'" data-align="false" class="J_cloud-handle cloud-navi-list" '+a.autoAttr+'> <div class="inner-wrap"> <a class="cloud-img-wrap" href="//'+a.data.url+"?source=suggest&suggest=navi_"+a.index+'_1" target="_self"> <img src="//img.alicdn.com/tps/i1/'+a.data.logo+'_70x70.jpg" /> </a> <p>'+a.data.title+'</p> <a class="cloud-btn-wrap" href="//'+a.data.url+"?source=suggest&suggest=navi_"+a.index+'_1" target="_self"> <span class="cloud-link">'+a.data.button+"</span><i>></i> </a> </div></div>";return t},qrcode:function(a){var t='<div id="J_CloudList'+a.prefix+'" data-align="false" class="J_cloud-handle cloud-qrcode" '+a.autoAttr+' > <div class="inner-wrap"> <a href="'+a.data.url+'"><img src="'+a.data.image+'"/></a> </div></div>';return t},spu:function(a){var t='<div id="J_CloudList'+a.prefix+'" data-align="false" class="J_cloud-handle cloud-spu-list" '+a.autoAttr+' > <div class="inner-wrap"> <ul> ',l=a.data;if(l)for(var s,i=-1,e=l.length-1;e>i;)s=l[i+=1],t+=' <li> <a class="cloud-img-wrap cloud-link" href="//'+s.url+"&source=suggest&suggest=spu_"+a.index+"_"+(~~i+1)+'" target="_self"> <img src="//img.alicdn.com/tps/i1/'+s.pic+'_50x50.jpg" /> </a> <a class="cloud-title" title="'+s.title+'" href="//'+s.url+"&source=suggest&suggest=spu_"+a.index+"_"+(~~i+1)+'" target="_self"> <span>'+s.title+'</span> </a> <p class="cloud-price '+(0===~~s.price?"cloud-hidden":"")+'">参考价:<b class="">￥'+s.price+'</b><b class="noprice">暂无</b></p> </li> ';return t+=' </ul> <p class="cloud-total '+a.ishidden+'"> <span class="total">共'+a.count+'款产品</span> <a class="more" target="_self" href="//'+a.link+"&source=suggest&suggest=spu_"+a.index+'_more">查看全部>></a> </p> </div></div>'},tag:function(a){var t='<div id="J_CloudList'+a.prefix+'" data-align="true" class="J_cloud-handle cloud-list" '+a.autoAttr+' > <div class="inner-wrap"><h3>'+a.tagTitle+"</h3> <ul> ",l=a.data;if(l)for(var s,i=-1,e=l.length-1;e>i;)s=l[i+=1],t+=' <li><a target="_self" href="'+a.action+"?q="+a.tagTitle+" "+s+"&wq="+a.query+"&source=suggest&suggest=magic_"+a.index+"_"+(~~i+1)+"&tag="+s+a.param+'" class="cloud-link"><span>'+s+"</span></a></li> ";return t+=" </ul> </div></div>"},tag_group:function(a){var t='<div id="J_CloudList'+a.prefix+'" data-align="true" class="J_cloud-handle cloud-list type-taggroup" '+a.autoAttr+' > <div class="inner-wrap"><h3>'+a.tagTitle+"</h3> <ul> ",l=a.data;if(l)for(var s,i=-1,e=l.length-1;e>i;){s=l[i+=1],t+=' <li  class="tag-group"> <ul> ';var r=s;if(r)for(var d,u=-1,n=r.length-1;n>u;)d=r[u+=1],t+=' <li> <a target="_self" href="'+a.action+"?q="+encodeURIComponent(a.tagTitle+" "+d.title)+"&wq="+a.query+"&source=suggest&suggest=magic_"+a.index+"_"+(~~u+1)+"&tag="+d.title+a.param+'" class="cloud-link '+d.type+'"><span>'+d.title+"</span></a> </li> ";t+=" </ul> </li> "}return t+=" </ul> </div></div>"},topbrand:function(a){var t='<div id="J_CloudList'+a.prefix+'" data-align="false" class="J_cloud-handle cloud-topbrand-list" '+a.autoAttr+' > <div class="inner-wrap"> <h3>“'+a.tagTitle.substr(0,11)+"”热门品牌</h3><ul> ",l=a.data;if(l)for(var s,i=-1,e=l.length-1;e>i;)s=l[i+=1],t+=' <li> <a class="cloud-title cloud-link" href="//'+s.url+"&source=suggest&suggest=brandlist_"+a.index+"_"+(~~i+1)+'" target="_self"> <span><i class="cloud-top'+i+'">'+(~~i+1)+"</i>"+s.title+"</span> </a> </li> ";return t+=" </ul> </div></div>"}}});KISSY.add("tbc/search-suggest/6.3.1/mods/bts",["base","tbc/search-suggest/6.3.1/mods/utils"],function(t,e,s,u){function c(t){c.superclass.constructor.call(this,t||{})}var n=e("base"),r=e("tbc/search-suggest/6.3.1/mods/utils");KISSY.extend(c,n,{getBucket:function(){var t=this,e=t.getCookieT(),s=t.getTestBucket()||t.retBucket(e,20,-4,4)-0;return s},getTestBucket:function(){var t=location.search,e=t.match(/alg_bts=(\d+)/);return e&&e[1]?e[1]-0:void 0},getCookieT:function(){var t=new r,e=t.getCookie("t");return e},retBucket:function(t,e,s,u){return!t&&"0"||this.countBucket(t,e,s,u)},countBucket:function(t,e,s,u){var c=t.substr(s,u),n=parseInt(c,16),r=n%e+1;return r+""}},{ATTRS:{pluginId:{value:"bts"}}}),u.exports=c});