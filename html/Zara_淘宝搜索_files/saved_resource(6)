KISSY.add("tbc/search-suggest/6.3.1/index",["combobox","base","json","cookie","event","node","dom"],function(e,t,n,r){var o,a,i,s,u,c,l,f,d,p,g=t("combobox"),h=t("base"),m=t("json"),v=(t("cookie"),t("event")),_=t("node"),y=t("dom");o=function(e){function t(e){t.superclass.constructor.call(this,e||{})}var n=g;return t=n.extend({initializer:function(){var e=this;e.on("afterRenderData",function(){e.fire("beforeShow")})},sendRequest:function(e){var t=this,n=t.constructor.superclass.sendRequest;if(t.fire("beforeQueryChange",{query:e})===!1)return!1;t.queryTimer&&clearTimeout(t.queryTimer),t.laterTimer&&clearTimeout(t.laterTimer);var r=arguments;t.queryTimer=setTimeout(function(){t.queryTimer=null,t.laterTimer=setTimeout(function(){t.later=!1},500),n.apply(t,r)},t.later?200:50),t.later=!0},handleKeyDownInternal:function(e){var t=this,n=t.constructor.superclass.handleKeyDownInternal;return t.fire("beforeKeyDown",{event:e})===!1?!1:void n.apply(this,arguments)},handleKeyEventInternal:function(e){var t=this,n=t.constructor.superclass.handleKeyEventInternal;return t.fire("beforeKeyDown",{event:e})===!1?!1:void n.apply(this,arguments)},setValueInternal:function(e){var t=this,n=t.constructor.superclass.setValueInternal;return t.fire("beforeSetInputValue",{event:e})===!1?!1:void n.apply(this,arguments)},setValueFromAutocomplete:function(e){var t=this,n=t.constructor.superclass.setValueFromAutocomplete;return t.fire("beforeSetInputValue",{event:e})===!1?!1:void n.apply(this,arguments)},renderItems:function(e,t,n){var r,o,a=this,i=a.get("sugConfig").resultFormat,s=a.resultArr||(a.resultArr=[]),u="",c=e;KISSY.each(t,function(e,a){if(!e||!e[0])return void t.splice(a,1);for(r=e[0];r.indexOf(c)<0;)c=c.substr(0,c.length-1);""===c?(u=r,r=""):0===r.indexOf(c)&&(u=c,r=r.replace(c,""));for(var l in s)if(o=s[l],o.textContent===e[0]&&o.unique)return;n=n.replace("{format}",i),s.push({textContent:e[0],content:KISSY.substitute(n,{query:u,text:r,index:a+1,count:e[1]}),list:!0})}),a.resultArr=s},alignInternal:function(e){var t=this,n=t.constructor.superclass.alignInternal;return t.fire("beforeShow",{event:e})===!1?!1:void n.apply(this,arguments)}},{ATTRS:{dataSourceCfg:{value:{xhrCfg:{url:"",dataType:"jsonp",scriptCharset:"utf-8",data:{code:"utf-8"}},allowEmpty:!0,paramName:"q",cache:!0}},mods:{value:{},setter:function(e){return e}}}}),t.RemoteDataSource=n.RemoteDataSource,t.LocalDataSource=n.LocalDataSource,e=t}(),a=function(e){return e={"new":{tmpl:'<div class="item-wrapper {prefixCls}menu-extras-xp" data-key="q={$queryUrl}&suggest=new_{$index}&tab=shopping&auction_tag[]=1154"><span class="{prefixCls}menu-xp-tag">新品</span><span class="{prefixCls}menu-xp-icon">新品</span><span class="{prefixCls}menu-xp">“{$query}”相关{new}新品</span></div>'},shop:{tmpl:'<div class="item-wrapper {prefixCls}menu-extras-dp" data-action="//shopsearch.taobao.com/search" data-key="q={$queryUrl}&suggest=shop_{$index}"><span class="{prefixCls}menu-dp">{$query} <b>相关店铺</b></span><span class="{prefixCls}menu-dp-icon">店铺</span></div>'},cat:{tmpl:'<div class="{prefixCls}menu-extras-cate" data-key="q={$3}&cat={$1}&suggest=cat_{$index}"><span class="{prefixCls}menu-key">{$2}</span><span class="{prefixCls}menu-cate">在<b>{$0}</b>分类下搜索</span></div>'},list:{tmpl:"<div data-index='{index}' class='item-wrapper' data-key='q={textContent}&suggest=0_{index}'><span class='item-text'>{query}<b>{text}</b></span><span class='item-count'>{format}</span></div>"},global:{tmpl:'<div class="{prefixCls}menu-extras-cate" data-key="q={$queryUrl}&promote=2097152&suggest=global_{$index}"><span class="{prefixCls}menu-key">{$query}</span><span class="{prefixCls}menu-cate">在全球购市场中搜索</span></div>'},history:{tmpl:'<div class="{prefixCls}menu-extras-history" {attr} data-key="q={historyItemQuery}&suggest={extraParam}_{index}" data-index="_his_{index}" data-value="{historyItemValue}"><span class="{prefixCls}menu-history-key">{historyItemValue}</span><span data-type="{extraParam}" class="{prefixCls}menu-history-delete">删除</span></div>'},scene:{tmpl:'<div class="{prefixCls}menu-extras-cate extras-scene" data-action="//fa.taobao.com/search" data-key="q={scene}&suggest=scene_{$index}"><span class="{prefixCls}menu-key">{scene}</span><b>装修宝典/选购秘籍</b></div>'},dapei_bottom:{tmpl:'<div class="item-wrapper {prefixCls}menu-extras-dp" data-source-stat="source_click=suggest_kfc&source_pv=suggest_kfc#!Content" data-action="//pose.taobao.com/search" data-key="q={dapei_bottom}"><span class="{prefixCls}menu-dp">{dapei_bottom}<b>全套搭配</b></span></div>'},dapei_top:{tmpl:'<div class="{prefixCls}menu-extras-cate" data-source-stat="source_click=suggest_jqc&source_pv=suggest_jqc#!Content" data-action="//pose.taobao.com/search" data-key="q={dapei_top}"><span class="{prefixCls}menu-key">{dapei_top}</span><span class="{prefixCls}menu-cate">在<b>搭配</b>下搜索</span></div>'},tmall:{tmpl:'<div class="{prefixCls}menu-extras-cate extras-mall" data-key="q={tmall}&suggest=tmall_{$index}&tab=mall"><span class="{prefixCls}menu-key">{tmall}</span><b>天猫相关</b></div>'},c2c_activity:{tmpl:'<div class="{prefixCls}menu-extras-cate extras-active" data-key="q={c2c_activity_query} {c2c_activity_tag}&suggest=active_{$index}&tab=deal"><span class="{prefixCls}menu-key">{c2c_activity_query}</span><span class="{prefixCls}menu-cate">在 <b>{c2c_activity_tag}</b> 中搜索</span></div>'},showExtra:!1}}(),i=function(e){function t(e){return n?n:(t.superclass.constructor.call(this,e||{}),void(n=this))}var n,r=h;return KISSY.extend(t,r,{pluginInitializer:function(e){var t=this;t.set("caller",e)},getCookie:function(e){var t=window;if(t.userCookie&&!KISSY.isUndefined(t.userCookie[e]))return t.userCookie[e];if(t.SRP_COOKIES||(t.SRP_COOKIES={})&&KISSY.isUndefined(SRP_COOKIES[e])){var n=document.cookie.match("(?:^|;)\\s*"+e+"=([^;]*)");SRP_COOKIES[e]=n&&n[1]?decodeURIComponent(n[1]):""}return SRP_COOKIES[e]},fireEvent:function(e,t){var n=document;if(n.createEvent){var r=n.createEvent("MouseEvents");r.initEvent(t,!0,!1),e.dispatchEvent(r)}else n.createEventObject&&e.fireEvent("on"+t)}},{ATTRS:{pluginId:{value:"utils"}}}),e=t}(),s=function(e){return e={},!function(t){function n(e,t){t=t||{},this._id=n._generateUUID(),this._promise=t.promise||Promise,this._frameId=t.frameId||"CrossStorageClient-"+this._id,this._origin=n._getOrigin(e),this._requests={},this._connected=!1,this._closed=!1,this._count=0,this._timeout=t.timeout||5e3,this._listener=null,this._installListener();var r;t.frameId&&(r=document.getElementById(t.frameId)),r&&this._poll(),r=r||this._createFrame(e),this._hub=r.contentWindow}n.frameStyle={display:"none",position:"absolute",top:"-999px",left:"-999px"},n._getOrigin=function(e){var t,n,r;return t=document.createElement("a"),t.href=e,t.host||(t=window.location),n=t.protocol&&":"!==t.protocol?t.protocol:window.location.protocol,r=n+"//"+t.host,r=r.replace(/:80$|:443$/,"")},n._generateUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)})},n.prototype.onConnect=function(){var e=this;return this._connected?this._promise.resolve():this._closed?this._promise.reject(new Error("CrossStorageClient has closed")):(this._requests.connect||(this._requests.connect=[]),new this._promise(function(t,n){var r=setTimeout(function(){n(new Error("CrossStorageClient could not connect"))},e._timeout);e._requests.connect.push(function(e){return clearTimeout(r),e?n(e):void t()})}))},n.prototype.set=function(e,t){return this._request("set",{key:e,value:t})},n.prototype.get=function(){var e=Array.prototype.slice.call(arguments);return this._request("get",{keys:e})},n.prototype.del=function(){var e=Array.prototype.slice.call(arguments);return this._request("del",{keys:e})},n.prototype.clear=function(){return this._request("clear")},n.prototype.getKeys=function(){return this._request("getKeys")},n.prototype.close=function(){var e=document.getElementById(this._frameId);e&&e.parentNode.removeChild(e),window.removeEventListener?window.removeEventListener("message",this._listener,!1):window.detachEvent("onmessage",this._listener),this._connected=!1,this._closed=!0},n.prototype._installListener=function(){var e=this;this._listener=function(t){var n,r,o,a;if(!e._closed&&t.data&&"string"==typeof t.data&&(r="null"===t.origin?"file://":t.origin,r===e._origin))if("cross-storage:unavailable"!==t.data){if(-1!==t.data.indexOf("cross-storage:")&&!e._connected){if(e._connected=!0,!e._requests.connect)return;for(n=0;n<e._requests.connect.length;n++)e._requests.connect[n](o);delete e._requests.connect}if("cross-storage:ready"!==t.data){try{a=JSON.parse(t.data)}catch(i){return}a.id&&e._requests[a.id]&&e._requests[a.id](a.error,a.result)}}else{if(e._closed||e.close(),!e._requests.connect)return;for(o=new Error("Closing client. Could not access localStorage in hub."),n=0;n<e._requests.connect.length;n++)e._requests.connect[n](o)}},window.addEventListener?window.addEventListener("message",this._listener,!1):window.attachEvent("onmessage",this._listener)},n.prototype._poll=function(){var e,t,n;e=this,n="file://"===e._origin?"*":e._origin,t=setInterval(function(){return e._connected?clearInterval(t):void(e._hub&&e._hub.postMessage("cross-storage:poll",n))},1e3)},n.prototype._createFrame=function(e){var t,r;t=window.document.createElement("iframe"),t.id=this._frameId;for(r in n.frameStyle)n.frameStyle.hasOwnProperty(r)&&(t.style[r]=n.frameStyle[r]);return window.document.body.appendChild(t),t.src=e,t},n.prototype._request=function(e,t){var n,r;return this._closed?this._promise.reject(new Error("CrossStorageClient has closed")):(r=this,r._count++,n={id:this._id+":"+r._count,method:"cross-storage:"+e,params:t},new this._promise(function(e,t){var o,a,i;o=setTimeout(function(){r._requests[n.id]&&(delete r._requests[n.id],t(new Error("Timeout: could not perform "+n.method)))},r._timeout),r._requests[n.id]=function(a,i){return clearTimeout(o),delete r._requests[n.id],a?t(new Error(a)):void e(i)},Array.prototype.toJSON&&(a=Array.prototype.toJSON,Array.prototype.toJSON=null),i="file://"===r._origin?"*":r._origin,r._hub.postMessage(JSON.stringify(n),i),a&&(Array.prototype.toJSON=a)}))},"undefined"!=typeof r&&r.exports?e=n:"undefined"!=typeof e?e.CrossStorageClient=n:"function"==typeof define&&define.amd?define([],function(){return n}):t.CrossStorageClient=n}(this),e=r.exports}(),u=function(e){return function(t){function n(){}function o(e,t){return function(){e.apply(t,arguments)}}function a(e){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],f(e,this)}function i(e,t){for(;3===e._state;)e=e._value;return 0===e._state?void e._deferreds.push(t):(e._handled=!0,void a._immediateFn(function(){var n=1===e._state?t.onFulfilled:t.onRejected;if(null===n)return void(1===e._state?s:u)(t.promise,e._value);var r;try{r=n(e._value)}catch(o){return void u(t.promise,o)}s(t.promise,r)}))}function s(e,t){try{if(t===e)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var n=t.then;if(t instanceof a)return e._state=3,e._value=t,void c(e);if("function"==typeof n)return void f(o(n,t),e)}e._state=1,e._value=t,c(e)}catch(r){u(e,r)}}function u(e,t){e._state=2,e._value=t,c(e)}function c(e){2===e._state&&0===e._deferreds.length&&a._immediateFn(function(){e._handled||a._unhandledRejectionFn(e._value)});for(var t=0,n=e._deferreds.length;n>t;t++)i(e,e._deferreds[t]);e._deferreds=null}function l(e,t,n){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=n}function f(e,t){var n=!1;try{e(function(e){n||(n=!0,s(t,e))},function(e){n||(n=!0,u(t,e))})}catch(r){if(n)return;n=!0,u(t,r)}}var d=setTimeout;a.prototype["catch"]=function(e){return this.then(null,e)},a.prototype.then=function(e,t){var r=new this.constructor(n);return i(this,new l(e,t,r)),r},a.all=function(e){var t=Array.prototype.slice.call(e);return new a(function(e,n){function r(a,i){try{if(i&&("object"==typeof i||"function"==typeof i)){var s=i.then;if("function"==typeof s)return void s.call(i,function(e){r(a,e)},n)}t[a]=i,0===--o&&e(t)}catch(u){n(u)}}if(0===t.length)return e([]);for(var o=t.length,a=0;a<t.length;a++)r(a,t[a])})},a.resolve=function(e){return e&&"object"==typeof e&&e.constructor===a?e:new a(function(t){t(e)})},a.reject=function(e){return new a(function(t,n){n(e)})},a.race=function(e){return new a(function(t,n){for(var r=0,o=e.length;o>r;r++)e[r].then(t,n)})},a._immediateFn="function"==typeof setImmediate&&function(e){setImmediate(e)}||function(e){d(e,0)},a._unhandledRejectionFn=function(e){"undefined"!=typeof console&&console&&console.warn&&console.warn("Possible Unhandled Promise Rejection:",e)},a._setImmediateFn=function(e){a._immediateFn=e},a._setUnhandledRejectionFn=function(e){a._unhandledRejectionFn=e},"undefined"!=typeof r&&r.exports?e=a:t.Promise||(t.Promise=a)}(this),e=r.exports}(),c=function(e){function t(e){t.superclass.constructor.call(this,e||{})}var n=h,r=i;return KISSY.extend(t,n,{getBucket:function(){var e=this,t=e.getCookieT(),n=e.getTestBucket()||e.retBucket(t,20,-4,4)-0;return n},getTestBucket:function(){var e=location.search,t=e.match(/alg_bts=(\d+)/);return t&&t[1]?t[1]-0:void 0},getCookieT:function(){var e=new r,t=e.getCookie("t");return t},retBucket:function(e,t,n,r){return!e&&"0"||this.countBucket(e,t,n,r)},countBucket:function(e,t,n,r){var o=e.substr(n,r),a=parseInt(o,16),i=a%t+1;return i+""}},{ATTRS:{pluginId:{value:"bts"}}}),e=t}(),l=function(e){function t(e){return n||(t.superclass.constructor.call(this,e||{}),n=this,n.initialize()),n}var n,r=h,o=m,a=s,i=u;return KISSY.extend(t,r,{initialize:function(e){this.makeCompatible(),this.initStorage()},makeCompatible:function(){window.__StorageIsReady=function(){KISSY.log("[warning]: not use flash any more, you can remove `window.__StorageIsReady()` call, see: https://aone.alibaba-inc.com/task/12460577")}},initStorage:function(){this.storage=new a("https://www.taobao.com/markets/search/search-suggest-history-iframe",{promise:i})},save:function(e,t,n){n&&n.onFailure&&n.onFailure()},read:function(e,t,n){t&&t.onFailure&&t.onFailure()},writeAsync:function(e,t){var n=this.storage;return n.onConnect().then(function(){var r=o.stringify(t);return n.set(e,r)})},onReady:function(){return this.storage.onConnect()},readAsync:function(e){var t=this.storage;return t.onConnect().then(function(){return t.get(e)}).then(function(e){var t;try{t=o.parse(e)}catch(n){}return t})}}),e=t}(),f=function(t){function n(e){n.superclass.constructor.call(this,e||{}),this.initialize()}var r=h,o=l,a="suggest_history_",i=7,s=100;return KISSY.extend(n,r,{initialize:function(){var e=this,t=e.get("name"),n=e.get("tab"),r=e.get("user");"item"===n&&(n="baobei"),e.storageKey=a+t+n+r,e._initStorage(),e.loadHistory()},_setKey:function(e){var t=this,n=e.name||t.get("name"),r=e.tab||t.get("tab"),o=e.user||t.get("user");"item"===r&&(r="baobei"),t.storageKey=a+n+r+o,t.set("tab",r),t.set("name",n),t.set("user",o)},_initStorage:function(){var e=this.get("storageType");switch(e){case"flashStorage":KISSY.log("`storageType=flashStorage`, flash 已下线，使用 iframe localStorage 支持"),this.storage=this._initFlashStorage();break;default:this.storage=this._initIframeStraoge()}},_initFlashStorage:function(){return this._initIframeStraoge()},_initIframeStraoge:function(){var e=this;return{save:function(){return(new o).writeAsync(e.storageKey,e.getDataList())},read:function(){return(new o).readAsync(e.storageKey)},onReady:function(){return(new o).onReady()}}},checkFlash:function(e){this.storage.onReady().then(e&&e.onSuccess,e&&e.onFailure)},loadHistory:function(){var e=this;return this.storage.read().then(function(t){e.setDataList(t),e.translateCn2Pinyin(t)})},translateCn2Pinyin:function(t){t=t||[];for(var n=[],r=0,o=t.length;o>r;r++){var a=t[r],i=/[\u4e00-\u9fa5]/,s=decodeURIComponent(a.value);i.test(s)&&n.push(s)}var u=",,,";if(n.length){this.__cnList=n,this.__cnSep=u,KISSY.suggestHistoryJSONP=e.bind(this._mergeCnPinyin,this);var c=location.protocol+"//suggest.taobao.com/sug?code=utf-8&area=py&callback=KISSY.suggestHistoryJSONP&q="+n.join(u);KISSY.getScript(c)}},_mergeCnPinyin:function(t){if(t&&t.result){var n=t.result[0]||"",r=n.split(this.__cnSep);if(this.__cnList&&r.length===this.__cnList.length){var o={},a=this;e.each(this.__cnList,function(e,t){o[a.__cnList[t]]=r[t]});for(var i=this.getDataList(),s=0,u=i.length;u>s;s++){var c=i[s],l=decodeURIComponent(c.value);o[l]&&(c.value=o[l])}this.setDataList(i)}}},purge:function(t){for(var n=[],r=e.now()-24*i*3600*1e3,o=0,a=t.length;a>o;o++){var u=t[o];u.time>r&&n.push(u)}return n.sort(function(e,t){return t.time-e.time}),n.length>s&&(n.length=s),n=this._distinctByValue(n)},getDataList:function(){var e=this._datalist||[];return e.concat()},setDataList:function(e){e=this.purge(e||[]),this._datalist=e.concat()},addTobeSavedList:function(t,n){if(!t.match(/<>'"/)&&!n.match(/<>'"/)){var r=this.getDataList(),o={key:encodeURIComponent(t),value:encodeURIComponent(n),time:e.now()};r.unshift(o),this.setDataList(r)}},_distinctByValue:function(e){for(var t,n=[],r=0,o=e.length;o>r;r++)t=e[r],t.value.match(/%3C|%3E|[<>'"]/g)||this._hasItemOfValue(n,t.value)||n.push(t);return n},_hasItemOfValue:function(e,t){for(var n=!1,r=e.length-1;r>=0;r--)e[r].value===t&&(n=!0);return n},save:function(e,t){""!==t&&(this.addTobeSavedList(e,t),this.storage.save())},query:function(t){var n=this.getDataList();if(t){t=encodeURIComponent(t);var r,o,a=[];return e.each(n,function(e){r=e.key,o=e.value,(0===r.indexOf(t)||0===o.indexOf(t))&&a.push(e)}),a}return n},deleteItem:function(e){for(var t=this.getDataList(),n=encodeURIComponent(e),r=[],o=0,a=t.length;a>o;o++){var i=t[o];i.key!=n&&r.push(i)}this.setDataList(r),this.storage.save()},destructor:function(){this._datalist=null,a=null},clearByDay:function(){},hasHistory:function(){},_query:function(e){},_deleteItemByValue:function(e,t){}},{ATTRS:{name:{value:"default",setter:function(e){return e}},user:{value:"",setter:function(e){return KISSY.fromUnicode(e)}},maxLength:{value:500},storageType:{value:"flashStorage",setter:function(e){return e},getter:function(e){return e}}}}),t=n}(),d=function(e){function t(e){t.superclass.constructor.call(this,e||{})}var n=h,r=v,o=f;return KISSY.extend(t,n,{pluginInitializer:function(e){var t=this,n=t.get("stat");t.set("caller",e),e.on("beforeSubmit",function(e){var n=e.isInitSearch;t.setStat(n)}),n&&(t.sendTongji(),t.bindSearchTrace())},bindSearchTrace:function(){var e=this;r.delegate("body","click","a",e.initSearchTrace,e)},initSearchTrace:function(e){var t=this,n=e.currentTarget,r=n.getAttribute("trace"),o=n.getAttribute("href");if(r)switch(r){case"relatedSearch":t.saveQuery();break;case"auction":var a=t.stat;a&&-1===o.indexOf("initiative_new")&&n.setAttribute("href",o+"&initiative_new=1")}},sendTongji:function(){var e,t=this,n=t.getStatInst();n.checkFlash({onSuccess:function(){e=n.query("stat")[0],e&&e.value&&(t.stat=e.value,t.send("f_stats_show="+e.value,!0))}})},setStat:function(e,t){var n=this,r=n.get("caller"),o=r.query,a=n.saveQuery(o,e);a&&n.send("lf_aclog=null-null-null-null-0&stats_click="+a,t)},getStatInst:function(){var e=this,t=e.get("caller"),n=t.get("sugConfig"),r=n.tab||"",a=new o({name:"stat",tab:r});return a},saveQuery:function(e,t){var n,r,o=this.getStatInst();return t&&e?(n=encodeURIComponent(e),r="initiative_new:1;q:"+n,o.save("stat",r)):o.deleteItem("stat"),r},send:function(e,t){var n,r;t?(n="/tongji",r="H51884970"):(n="/search",r="H51884969"),(window.goldlog_queue||(window.goldlog_queue=[])).push({action:"goldlog.record",arguments:[n,"",e,r]})},renderPlugin:function(){}},{ATTRS:{pluginId:{value:"stat"}}}),e=t}(),p=function(e){var t=_,n=h,r=y,s=o,u=a,l=c,f=i,p=d,g=n.extend({initializer:function(){var e=this;e._initCombo(),e.bindUtil()},bindUtil:function(){var e=this;e.Utils=new f,e.Stat=new p},_setComboCache:function(e){var t=this,n=t.get("tab");t.configArr=t.configArr||[],t.configArr[n]={data:e}},_checkHasTab:function(){var e=this,t=e.getPlugin("tab");t||(e.tabNode=e.get("form"))},_initComboEvent:function(){var e=this,t=e.comboBox,n=t.get("input");n.on("mousedown",function(r){if(e.fire("beforeFocus")!==!1){var o=KISSY.trim(n.val()),a=e.get("sugConfig"),i=!0;i&&(a.autoCollapsed||""===o)&&t.sendRequest(o)}r.stopPropagation()}),n.on("focus",function(){e.fire("beforeFocus")}),n.on("blur",function(){return e.fire("beforeBlur")===!1?!1:void 0});var o=e.get("sugConfig").itemClick,a=!0;if(o&&KISSY.isFunction(o)){a=!1;var i=o.apply(this,arguments);i!==!1&&(a=!0)}a&&t.on("click",e.comboClick,e),t.on("afterCollapsedChange",e._addExtraEvent,e),t.on("afterCollapsedChange",function(t){e.fire("afterCollapsedChange",t)}),t.on("beforeQueryChange",function(t){e.fire("beforeQueryChange",t)}),t.on("beforeSetInputValue",function(){var t=e.get("label");t&&r.hide(t)}),e._formSubmitEvent(),e.query=n.val();var s=e.get("label");s&&s.on("click",function(){t.sendRequest(n.val())})},_formSubmitEvent:function(){var e,t=this,n=t.comboBox,r=n.get("input"),o=r.parent("form"),a=n.get("input");o.on("submit",function(n){t.fire("beforeSubmit",{el:o,isInitSearch:!0})!==!1?(e=o.attr("action"),""===KISSY.trim(a.val())&&t._emptyJump(o)===!1&&n.preventDefault(),t.serializeToForm(o,e)):n.halt()})},serializeToForm:function(e,t){var n,r,o,a="",i="";if(t&&e){if(-1===t.indexOf("?"))return;if(a=t.split("?")[1]){n=a.split("&");for(var s in n)r=n[s].split("="),o=r[0],o&&!e[0][o]&&(i+='<input type="hidden" name="'+r[0]+'" value="'+r[1]+'"/>');e.append(i)}}},_defaultPageJump:function(e){var t,n=this,r=n.tabNode;if(!r)return!1;if(t=e.attr("data-defaultpage")||r.attr("data-defaultpage")){if(!/(http(s:|:))?\/\//.test(t))return!1;e.attr("action",t)}},_emptyJump:function(e){var t,n=this,r=e.one("label");return r?(t=r.one("span"),t&&""!==t.text()?(r.hide(),void n._holderJump(e,t.text())):n._defaultPageJump(e)):n._defaultPageJump(e)},_holderJump:function(e,t){var n=e[0].q;n&&(n.value=t),e.append('<input type="hidden" name="style" value="grid" />')},_sendSnapshot:function(e){for(var t=this,n=[],r=-1,o=0;o<e.children.length;o++){var a=e.children[o];e.selected==a.value?r=o:n.push(a.value+"/"+a.index)}var i="f_stats_show=xialalist:";i+=n.join(","),i=i+";query:"+e.query,i=i+";selected:"+e.selected+"/"+r,i=i+";time:"+KISSY.now(),i=i+";nick:"+t.getNick(),t.Stat.send(i,!0)},comboClick:function(e){var n,r=this,o=e.target.get?e.target.get("el"):t.one(e.currentTarget),a=r.comboBox,i=o.one(".item-text, .search-menu-key, .search-menu-history-key"),s=!1,u=r.get("form"),c=r.get("sugConfig").isSendByForm;if(i){n=i.text();var l=r.historyArr;if(l)for(var f=0,d=l.length-1;d>=f;f++)if(n===l[f]){s=!0;break}}for(var p=a.get("menu"),g=p.get("children"),h=[],m=0;m<g.length;m++){var v=g[m],_=v.get("value");_&&h.push({index:m,value:_[0]})}var y={query:r.query||"",children:h,selected:n||""};if(r._sendSnapshot(y),r.fire("beforeSubmit",{el:o,isInitSearch:!1,isNotSave:s})!==!1){var x=r.getRedirect(o);c?(r.serializeToForm(u,x),u[0].submit()):r.redirect(x)}},getRedirect:function(e){var t=this,n=t.query,o=t.query,a=r.children(e),i=r.attr(a,"data-key")||"q="+n,s=t.get("form")[0],u=r.attr(s,"action"),c=r.attr(a,"data-action")||t.get("action")||u,l=r.attr(a,"data-source-stat")||"source=suggest",f="&_input_charset=utf-8&wq="+encodeURIComponent(o)+"&suggest_query="+encodeURIComponent(n)+"&"+l,d=t._getInputsVal(s);return c+=c.indexOf("?")>-1?"&":"?",c+d+"&"+i+f},redirect:function(e){var t=this,n=t.get("sugConfig").isEncode;n?e=t.urlEncode(e):(e=e.replace(/(#)[^!]/g,function(e,t){return e.replace(t,"%23")}),e=e.replace(/#!/g,"#"));var r=document.createElement("a");r.setAttribute("href",e),r.setAttribute("target","_self"),r.style.display="none",document.body.appendChild(r),r.click()},urlEncode:function(e){var t=/[\u4e00-\u9fa5\uf900-\ufa2d+#\s]+/g.exec(e);if(t)try{e=e.replace("？","?"),e=e.replace(/[\u4e00-\u9fa5\uf900-\ufa2d+#]+/g,function(e){return encodeURIComponent(e)}),e=e.replace(/\s/g,function(){return"+"}),e+="&ie=utf-8"}catch(n){KISSY.log("url编码出错!")}return e},_getInputsVal:function(e){for(var t,n,o=this,a=o.get("sugConfig"),i=a.excludeParam,s=[],u=r.query("input",e),c=u.length-1;c>=0;c--)t=u[c],n=t.name,n&&!KISSY.inArray(n,i)&&s.push(n+"="+encodeURIComponent(t.value));return s.length<1?"":"&"+s.join("&")},_getDefComboCfg:function(){return{focused:!1,hasTrigger:!1,matchElWidth:!0,srcNode:".allWidth",highlightMatchItem:!1,menu:{align:{overflow:{adjustY:0}}},cache:!0}},_prepareHtml:function(e){var n=this,o=r.get(e.node),a=o.innerHTML,i=e.prefixCls,s=r.get(e.placeholderEl),u=s?s.outerHTML:"",c='<div class="{cls}combobox"><div class="{cls}combobox-input-wrap"></div></div>',l=c.replace(/{cls}/g,i).replace(/{label}/g,u).replace(/{input}/g,a),f=r.create(l),d={"aria-haspopup":"true","aria-combobox":"list",role:"combobox",autocomplete:"off","class":i+"combobox-input","x-webkit-grammar":"builtin:translate"};return r.attr(o,"aria-label")||(d["aria-label"]=n._isOpen("history")?"请输入搜索文字或从搜索历史中选择":"请输入搜索文字"),r.attr(o,d),r.wrap(o,f),this.get("sugConfig").focused&&r.get(o).focus(),t.one("."+i+"combobox")},_isOpen:function(e){var t=this,n=t.get("mods"),r=n.sort;return KISSY.inArray(e,r)},_getRenderMods:function(){var e=this,t=KISSY.merge(u,e.get("mods"));e.set("mods",t)},_getDataSourceCfg:function(){var e=this,t=e.get("sugConfig"),n=e.get("dataSourceCfg"),r=t.sourceUrl;return location.href.indexOf("debug=test")>-1&&(r=r.replace("suggest.taobao.com/sug?","suggest.proxy.taobao.org/sug?")),-1===r.indexOf("bucketid")&&(r+=-1===r.indexOf("?")?"?bucketid="+e._getBucketId():"&bucketid="+e._getBucketId()),n.xhrCfg.url=r,n.parse=KISSY.bind(e.parse,e),n},_getBucketId:function(){return(new l).getBucket()},_getComboCfg:function(e){var n=this,r=n.get("sugConfig"),o=n._getDefComboCfg(),a=r.prefixCls,i=t.one("."+a+"-combobox");return i||(i=n._prepareHtml(r)),o.srcNode=i,o.dataSource=e,o.format=KISSY.bind(n.format,n),o.prefixCls=r.prefixCls,o.holderEl=t.one(r.placeholderEl),o.maxItemCount=o.maxItemCount||e.maxItemCount,o},_initCombo:function(){var e,t,n=this,r=n._getDataSourceCfg(),o=n.get("sugConfig");n._getRenderMods(),o.sourceUrl?(e=new s.RemoteDataSource(r),e.maxItemCount=10):(e=new s.LocalDataSource(r),e.maxItemCount=0),n._setComboCache(e),t=n._getComboCfg(e);var a=new s(t);a.render(),n.comboBox=a,n._checkHasTab(),n._initComboEvent()},update:function(e){for(var t=this,n=t.get("plugins"),r=0,o=n.length-1;o>=r;r++){var a=n[r];a&&KISSY.isFunction(a.update)&&a.update.call(a,e)}},parse:function(e,t){var n,r=this,o=r.fire("beforeParse",{results:t,query:e});if(o===!1)return[[""]];if(o&&(t=o),!t||!t.result)return KISSY.log("接口无数据!"),[[""]];n=t.result,delete t.result;var a=r.comboBox.get("dataSource");if((a.extraData||(a.extraData=[]))[e]=t,0===n.length)return[[""]];for(var i in n)n[i]||n.splice(i,1);return n},format:function(e,t){var n=this;return n.resultArr=[],n.render(e,t),n.resultArr},render:function(e,t){var n,r,o,a,i,s,u=this,c=u.get("mods"),l=c.sort,f=u._adjustExtra(e,c.showExtra);u.query=e;for(var d=0,p=l.length-1;p>=d;d++)if(s=l[d])if("list"!==s){if(i=u.getPlugin(s),i&&i.renderPlugin)i.renderPlugin({query:e,results:t});else if(r=c[s],r&&f&&(!(a=r.pos)||o!==a)){if(n=r.tmpl,!n)continue;var g=u.resultArr.length,h=u.diffLen||0;o=u.defaultRender({tmpl:n,name:s,pos:a,always:r.always&&t.length>0,callback:r.callback,index:g-h})}}else r=c[s],n=r.tmpl,u._list(e,t,n);u.fire("afterQueryChange",{query:e})},defaultRender:function(e){var t,n=this,r=e.tmpl,o=e.name,a=n.comboBox.get("dataSource"),i=n.query,s=n.get("sugConfig").prefixCls,u=a.extraData,c=e.pos,l=e.index;if(u&&u[i]||e.always){var f,d,p=n._getDate(),g={$query:i,$queryUrl:encodeURIComponent(i),$date:p,prefixCls:s};if(!e.always){if(f=u[i][o],d=!0,!f)return;if(KISSY.isArray(f)){f.length>2&&(f.length=2);for(var h=0,m=f.length;m>h;h++){var v=f[h];if(KISSY.isArray(v)){d=!1;for(var _=0,y=v.length;y>_;_++)g["$"+_]=v[_]||"";g.$3=encodeURIComponent(g.$2),g.$index=l+1+h,t=KISSY.substitute(r,g),n.addContent({html:t,query:i,position:c,callback:e.callback})}else g["$"+h]=v,g.$index=l+1+h}return d&&(t=KISSY.substitute(r,g),n.addContent({html:t,query:i,position:c,callback:e.callback})),c}if(KISSY.isObject(f)){for(var x in f)g[o+"_"+x]=f[x];"active"===o&&(g.$query=f.query+" "+f.tag)}else g[o]=f,g.$query=f}return g.$index=l+1,t=KISSY.substitute(r,g),n.addContent({html:t,query:g.$query||i,position:c,callback:e.callback}),c}},_adjustExtra:function(e){return""!==e?!0:!1},getNick:function(){var e=this;return e._getCookie("lgc")||e._getCookie("tracknick")},_getCookie:function(e){var t=window;if(t.userCookie&&!KISSY.isUndefined(t.userCookie[e]))return t.userCookie[e];if(t.SRP_COOKIES||(t.SRP_COOKIES={})&&KISSY.isUndefined(SRP_COOKIES[e])){var n=document.cookie.match("(?:^|;)\\s*"+e+"=([^;]*)");SRP_COOKIES[e]=n&&n[1]?decodeURIComponent(n[1]):""}return SRP_COOKIES[e]},_getDate:function(){var e=new Date;return e.getFullYear()+"-"+(e.getMonth()+1)+"-"+(e.getDate()+1)},_list:function(e,t,n){var r,o=this,a=o.get("sugConfig").resultFormat,i=o.resultArr||(o.resultArr=[]);KISSY.each(t,function(o,s){if(!o||!o[0])return void t.splice(s,1);var u,c=o[0],l="",f=e;if(c.match(/<b>/))r=c.replace(/<b>(\S+?)<\/b>/g,function(e,t){return t}),l=c,c="";else{for(;c.indexOf(f)<0;)f=f.substr(0,f.length-1);""===f?(l=c,c=""):0===c.indexOf(f)?(l=f,c=c.replace(f,"")):(l=c,c=""),r=o[0]}for(var d in i)if(u=i[d],u.textContent===o[0]&&u.unique)return;n=n.replace("{format}",a),i.push({textContent:r,content:KISSY.substitute(n,{query:l,text:c,index:s+1,count:o[1],textContent:encodeURIComponent(r)}),list:!0})}),o.resultArr=i},addContent:function(e){var t=this,n=e.html,r=e.position,o=e.query;if(!r){var a=t.resultArr||[];return void a.push({content:n,textContent:o})}t["__"+r]={tmpl:n},t._addExtraEvent()},_renderHeader:function(e,n,r){var o=n&&n.type+"-header"||"";if(n){var a=this.get("sugConfig").prefixCls;e||(e=new t("<div class='"+a+"combobox-menu-header "+o+"'></div>").prependTo(r)),e.empty().append(n.tmpl)}else e&&e.remove()},_renderFooter:function(e,n,r){var o=this,a=o.get("sugConfig").prefixCls,i=n&&n.type+"-footer"||"";if(n){e||(e=new t("<div class='"+a+"combobox-menu-footer "+i+"'></div>").appendTo(r)),n.css&&e.css(n.css),e.empty().append(n.tmpl);var s=e.one("."+a+"menu-history-clean");s&&s.on("click",function(e){e.halt();var t=o.getPlugin("history");t._cleanHistory()})}else e&&e.remove()},_addExtraEvent:function(e){var t=this,n=t.comboBox||t,r=t.__header,o=t.__footer,a=t.__lastHeader,i=t.__lastFooter,s=t.get("sugConfig").prefixCls;if(!e||e&&!e.newVal){var u=n.get("menu");if(!u.get)return;var c=u.get("el");if(!c||c.all("."+s+"menuitem").length<1)return;var l=c.one("."+s+"combobox-menu-header"),f=c.one("."+s+"combobox-menu-footer");a!==r&&(t.__lastHeader=r,t._renderHeader(l,r,c)),i!==o&&(t.__lastFooter=o,t._renderFooter(f,o,c))}else t.__header=null,t.__footer=null}},{ATTRS:{sugConfig:{value:{extraPassParams:"",extraPostParams:"",sourceUrl:"",tab:"item",autoCollapsed:!0,focused:!1,prefixCls:"search-",excludeParam:["q"],resultFormat:"约{count}个宝贝"},setter:function(e){var t=this.get("sugConfig");return KISSY.mix(t,e,void 0,void 0,!0)}},mods:{value:{},setter:function(e){return e}},input:{getter:function(e){return e||(e=this.comboBox.get("input"))}},form:{getter:function(e){return e||(e=this.get("input").parent("form"))}},label:{getter:function(e){return e||(e=this.comboBox.get("holderEl"))}},menu:{getter:function(e){return e||(e=this.comboBox.get("menu"))}},dataSourceCfg:{value:{xhrCfg:{url:"",dataType:"jsonp",scriptCharset:"utf-8",data:{code:"utf-8"}},allowEmpty:!0,paramName:"q",cache:!0}}}});return e=g}(),r.exports=p});KISSY.add("tbc/search-suggest/6.3.1/plugin/history",["ua","base","node","event","tbc/search-suggest/6.3.1/mods/local-query"],function(e,t,r,o){function i(e){i.superclass.constructor.call(this,e||{})}var a,n=t("ua"),s=t("base"),l=t("node"),u=(t("event"),t("tbc/search-suggest/6.3.1/mods/local-query"));KISSY.extend(i,s,{isSupported:function(){return n.ie?!1:!0},pluginInitializer:function(t){if(this.isSupported()){var r=this,o=t.get("sugConfig"),i=o.tab||"";a=t.Stat,t.set("extend",{history:!0}),r.set("caller",t),r.localQueryMap={},r.localQueryPinyingMap={},r.historyLocalQuery=r.localQueryMap[i]=new u({name:"history",tab:i,user:t.getNick()}),r.hitedHistoryListMap={};var n=t.comboBox;setTimeout(function(){r.historyLocalQuery.checkFlash({onSuccess:function(){r.historyReady=!0,n.on("afterCollapsedChange",function(e){if(!e.newVal){n.detach("afterCollapsedChange",arguments.callee);var t=n.get("menu").get("el");t.delegate("mousedown","."+o.prefixCls+"menu-history-delete",r._historyDeleteMousedown,r)}}),t.on("beforeSubmit",function(t){var o=n.get("input").val(),i=t.isNotSave;""===KISSY.trim(o)||o.match(/[<>'"]/g)||r.historyLocalQuery&&!i&&r.historyLocalQuery.save(o,e.trim(o))})},onFailure:function(){KISSY.log("load iframe localstorage failure!")}})},500)}},_dealUrl:function(e,t){var r="&area=history",o=e.indexOf(r)>-1;return t?!o&&e+r:o&&e.replace(r,"")},_getPinyinQuery:function(){},_renderHTML:function(e,t){var r,o=this,i=o.get("caller"),a="",n=i.get("mods").history.tmpl,t=t||{},s=i.resultArr||(i.resultArr=[]),l=[];e=KISSY.unique(e);for(var u=0,c=e.length-1;c>=u;u++)0!==u&&(t.attr=""),t.index=(u+1).toString(),t.historyItemValue=decodeURIComponent(e[u].key),t.historyItemQuery=e[u].key,a=KISSY.substitute(n,t),r=t.historyItemValue,l.push(r),s.push({content:a,textContent:r,unique:!0});i.historyArr=l},renderPlugin:function(){if(this.isSupported()&&this.historyReady){var e,t,r=this,o=r.get("caller"),i=o.query,a=r.historyLocalQuery.query(i),n=r.get("limit"),s=o.get("sugConfig"),l=o.comboBox.get("dataSource"),u=l.extraData&&l.extraData[i];if(r.get("web")&&""===i&&u&&u.cloud)return void r._renderHTML(u.cloud,{prefixCls:s.prefixCls});""===i&&a.length>0?(o.__header={tmpl:'<div class="history-box"><span>最近搜过</span></div>',type:"history"},o.__footer=null,e=n):(o.__header=null,o.__footer=null,e=2),t=a.splice(0,e),o._addExtraEvent(),r._renderHistoryItems(t),r.hitedHistoryListMap[i]=t}},_historyDeleteMousedown:function(e){for(var t=this,r=t.get("caller"),o=l.one(e.target),i=o.parent().attr("data-value"),a=o.parent(2),n=r.comboBox,s=n.get("menu"),u=s.get("children"),c=o.attr("data-type"),y=0;y<u.length;y++){var d=u[y];if(d.get("el")[0]===a[0]){s.removeChild(d,!0);break}}var h=t.historyLocalQuery;h&&("history"===c?h.deleteItem(i):"most"===c&&(h._setKey({name:"most"}),h.save(i,i),h._setKey({name:"history"}))),n.sendRequest(r.query),t._sendStat(i)},_sendStat:function(e){var t,r=this.get("caller"),o={},i=location.hostname,n="op=del&nk={nick}&src={host}&q={query}&app=sug";o.nick=r.getNick(),o.query=e,o.host=i.replace(/com|\./g,""),t=KISSY.substitute(n,o),a&&a.send(t)},_renderHistoryItems:function(e,t){var r=this,o={},i=r.get("caller"),a=i.get("sugConfig");o.prefixCls=a.prefixCls,o.attr=t&&t.attr||"",o.extraParam=t&&t.param||"history",r._renderHTML(e,o)},_getPinyin:function(e){},_retSug:function(e){},_cleanHistory:function(){var e=this,t=e.get("caller"),r=t.comboBox,o=r.get("menu"),i=o.get("el"),a=r.get("input"),n=t.get("sugConfig"),s=n.prefixCls,l=i.one("."+s+"combobox-menu-header");e.historyLocalQuery.clearByDay(0),e.hitedHistoryListMap={};var u=l.siblings();u.css("display","none"),l.html('<div class="history-box"><span>搜索历史已清空</span></div>');var c=new KISSY.Anim(i,{opacity:0},3,"easeIn",function(){u.css("display","block"),i.css({opacity:1,visibility:"hidden"})});c.run(),a.on("blur keydown mousedown",function(e){c.isRunning()&&c.stop(!0),t.__header=null,t.__footer=null,"keydown"===e.type&&this.value&&i.css("visibility","visible"),a.detach("blur keydown mousedown",arguments.callee)})},update:function(e){if(this.isSupported()){var t=this,r=encodeURI(e.tab);t.localQueryMap[r]||(t.localQueryMap[r]=new u({name:"history",tab:r,user:t.get("caller").getNick()})),t.historyLocalQuery=t.localQueryMap[r]}}},{ATTRS:{pluginId:{value:"history"},limit:{value:10,setter:function(e){return KISSY.isNumber(e)?e:void 0}}}}),o.exports=i});KISSY.add("tbc/search-suggest/6.3.1/plugin/cloud",["base","dom","node","event","cookie","tbc/search-suggest/6.3.1/mods/menu","tbc/search-suggest/6.3.1/tpl/cloud"],function(e,t,n,a){function o(e){o.superclass.constructor.call(this,e||{})}var r,i,s,l=t("base"),u=t("dom"),d=t("node"),c=t("event"),h=(t("cookie"),t("tbc/search-suggest/6.3.1/mods/menu")),g=t("tbc/search-suggest/6.3.1/tpl/cloud"),m=d.all;KISSY.extend(o,l,{pluginInitializer:function(e){var t,n,a=this,o=e.comboBox;a.isNotFirstRender=[],a.count=0,r=e,i=a.Utils,s=a.Stat,a.set("caller",e),a.initKeyEvent();var l=u.children(e.get("el")),c=e.get("form")[0],g=u.attr(c,"action"),m=u.attr(l,"data-action")||e.get("action")||g;a.set("action",m),o.on("beforeShow",function(){if(a.isShowFirstItem){var e=o.get("menu"),t=e.get("children");e.set("highlightedItem",t[0]),a.show(t[0].get("el")[0])}else a.setCloudHeight()}),e.on("afterCollapsedChange",function(o){o.newVal||(e.detach("afterCollapsedChange",arguments.callee),a.mouseArr=[],n=e.get("menu"),t=n.get("el"),t.addClass("search-cloud-menu"),a.initMenu||(d.one(".search-menu")&&(a.initMenu=!0,a.menu=new h({wrap:".search-menu",menu:".search-contentbox,.search-menu-content",rows:".search-menuitem",cls:".search-wrap-cloud",tolerance:500,handler:{enterHandler:function(t){e.fire("beforeCloudShow",{inst:a,el:t})!==!1&&a.show(t)},leaveHandler:function(e){a.hide(e)}}})),n.on("afterHighlightedItemChange",function(){a.setCloudHeight()}),a.initMouseEvent(t)))})},initMouseEvent:function(e){return e?void e.delegate("click",".cloud-list a",function(e){var t=e.currentTarget,n=t.getAttribute("href");n&&(n=r.urlEncode(n),t.setAttribute("href",n))}):!1},show:function(e){var t=this;t._showCloud(e),t.setCloudHeight()},hide:function(){this._hideCloud()},setCloudHeight:function(){var e,t=r.get("menu").get("el"),n=d.one(".cloud-footer");if(t.width()<500?t.addClass("narrow-suggest-menu"):t.removeClass("narrow-suggest-menu"),n){if(e=n.one(".cloud-box"),e.css("height","auto"),t.css("height","auto"),e){var a=t.height(),o=e.height();o>a?t.height(o-1):(t.css("height","auto"),e.css("height","100%"))}}else t.css("height","auto")},_hideCloud:function(){m(".cloud-footer").hide(),m(".search-menu-item-hover").removeClass("search-menu-item-hover")},_showCloud:function(e){var t,n,a,o=this,r=m(".search-wrap-cloud",e),i=d.one(".cloud-footer");m(".search-menu-item-hover").removeClass("search-menu-item-hover"),m(e).addClass("search-menu-item-hover"),o.lastItemIndex&&(n=d.one("#J_CloudList"+o.lastItemIndex),n&&n.hide(),i&&i.hide()),r.length&&(t=r.attr("data-index")||r.one("div").attr("data-index"),o.lastItemIndex=t,n=d.one("#J_CloudList"+t),n&&(a=n.attr("data-align"),o.set("align",!("true"!==a)),n.show(),i&&i.show(),o.setPadding(m(e),n)))},_sendStat:function(){var e="f_stats_show=magic:1",t=r.get("sugConfig").sourceUrl,n="";t&&t.match(/bucketid=\w+/)&&(n=t.match(/bucketid=(\w+)/)[1],e+=";bts:"+n),s&&s.send(e,!0)},getPadding:function(e,t){var n=32,a=d.one(".search-menu"),o=a.offset().top,r=e.offset().top,i=r-o,s=a.height(),l=t.height(),u=i-n,c=s-l-u-10;return u>0?c>=0?u:u-=39*Math.round(-c/39):void 0},initKeyEvent:function(){var e=this,t=r.comboBox,n=c.KeyCodes||d.KeyCode;t.on("beforeKeyDown",function(a){var o=this.get("menu");if(o.get){var i,s,l,u,c=a.event,h=o.get("highlightedItem"),g=o.get("children"),m=g.length;if(0===m)return void 0;switch(c.keyCode){case n.ENTER:var v=e.isShowMagic(),f=e.isShowItem(),p=v||f;return p&&(c.halt(),!v&&f&&KISSY.UA.ie>=10?h.fire("click"):p.click()),!1;case n.UP:case n.DOWN:var w,S;c.keyCode===n.UP?(S=m-1,w=-1):(S=0,w=1),e.isTriggerArrowKey=!0,h?(i=KISSY.indexOf(h,g),s=(i+w+m)%m):s=S;var C=d.one(".cloud-link-wrap-hover");return C&&C.removeClass("cloud-link-wrap-hover"),0===i&&-1===w||i===m-1&&1===w?(e._hideCloud(),o.set("highlightedItem",null),t._stopNotify=1,r.get("input").val(t._savedInputValue||t._savedValue),!1):(l=o._getNextEnabledHighlighted(s,w),o.set("highlightedItem",l),e.show(l.get("el")[0]),t._stopNotify=1,u=l.get("textContent"),t.setValueFromAutocomplete?t.setValueFromAutocomplete(u):(t._stopNotify=1,r.get("input").val(u)),t.fire("beforeSetInputValue",{event:c}),!1);case n.HOME:case n.END:return l=c.keyCode===n.END?o._getNextEnabledHighlighted(m-1,-1):o._getNextEnabledHighlighted(0,1),o.set("highlightedItem",l),e._showCloud(l.get("el")[0]),t.setValueFromAutocomplete?t.setValueFromAutocomplete(l.get("textContent")):(t._stopNotify=1,r.get("input").val(l.get("textContent"))),!1;default:e.directionEvent(c)}}})},isShowMagic:function(){var e,t,n,a=m(".J_cloud-handle");return a.each(function(t){var n=d.all(t);"none"!==u.css(n,"display")&&(e=n)}),e?(t=u.query(".cloud-link-wrap-hover")[0],t&&(n="a"===t.tagName.toLowerCase()?t:u.query("a",t)[0]),n):void 0},isShowItem:function(){var e=this;return e.isTriggerArrowKey&&u.get(".search-menu-item-hover")},directionEvent:function(e){var t,n,a,o,i,s=this;switch(e.keyCode){case 39:case 37:if(i=r.get("menu"),t=i.get("activeItem")||i.get("highlightedItem"),!t)return!0;if(n=t.get("el").one(".item-wrapper"),!n)return!0;if(a=n.attr("data-index"),!a)return!0;if(o=d.one("#J_CloudList"+a),!o)return!0;var l=e.keyCode-37?"next":"prev";s.getHighLightItem(o,l)}},getHighLightItem:function(e,t){var n=e.one(".cloud-link-wrap-hover");if(n){var a=parseInt(e.attr("data-select-index")),o=e.all(".cloud-link");a="next"==t?a<o.length-1?a+1:0:a>0?a-1:o.length-1,n.removeClass(".cloud-link-wrap-hover");var r=o.item(a);e.attr("data-select-index",a),r.parent().addClass("cloud-link-wrap-hover")}else{var i=e.one(".cloud-link").parent();i&&i.addClass("cloud-link-wrap-hover"),e.attr("data-select-index",0)}},setPadding:function(e,t){var n=this,a=t.one(".inner-wrap"),o=this.getPadding(e,a),r=n.get("align");r&&o&&a.css("paddingTop",o)},checkRender:function(e){var t,n=this,a=e.comboBox,o=e.query,r=a.get("dataSource"),i=r.extraData[o],s=e.resultArr;return t=""!==o&&i?{extra:i,query:o,results:s}:!1,n.extraData=i,n.isShowFirstItem=!1,t},isAutoShow:function(e){return!!(KISSY.isArray(e)&&e.length>0&&(e[0].list||e[0].tag))},renderPlugin:function(){var e=this,t=e.checkRender(r);if(!t)return!1;var n,a,o,i,s,l,u,d,c="",h=t.extra,g=t.results,m=t.query;e.isFirstShow=!1,n=KISSY.clone(h.magic);for(var v=e.isAutoShow(r.resultArr),f=0,p=g.length-1;p>=f;f++)if(a=g[f],s=a.content,o=s.match(/data-index='(\w+)'/),i=s.match(/data-key='([\S\s]+?)'/),o&&o[1]){o=o[1]-0,i&&i[1]&&(i=i[1]);for(var w in n)l=n[w],o===l.index-0&&(e._wrapItem(a,i),d=e._renderHTML({data:l,query:m,index:o,key:i,auto:v,type:l.type||"tag",tagTitle:decodeURIComponent(i.match(/q=([^&]+)/)[1]),action:e.get("action")}),d&&(c+=d),1===o&&d&&(u=!0))}var S={tmpl:'<div class="cloud-box">'+c+"</div>",type:"cloud"};if(v&&u?(S.css={display:"block"},e.isShowFirstItem=!0):(S.css={display:"none"},e.isShowFirstItem=!1),KISSY.UA.ie<7){var C=r.resultArr.length;S.css.height=26*C}r.__footer=S,r._addExtraEvent(),e.isTriggerArrowKey=!1},_wrapItem:function(e,t){var n;KISSY.isObject(e)&&(n=e.content,e.content="<div class='search-wrap-cloud' data-key='"+t+"'>"+n+"</div>")},_renderHTML:function(e){var t,n,a,o=this,r={},i=e.data,s=e.query,l=e.index,u=o.extraData,d=e.type,c=e.auto&&1===l?"style='display:block'":"";if(u&&u.event&&1===l)t=o.get("event-tmpl"),n=o.get("event-param");else{if(!d)return KISSY.log("魔盒类型不存在!"),c="",!1;if(a=o.get(d),!a)return KISSY.log("接口返回的类型"+d+"不存在对应的模板"),c="",!1;t=a.tmpl,a.length&&i.data&&i.data.length>a.length&&(i.data.length=a.length),a.sort&&o.sort(i.data),n=o.get("param")}r.param=n?"&"+n:"",r.query=s,r.index=l,r.prefix=e.prefix||l,r.tagTitle=e.tagTitle,r.action=e.action,i.count&&i.count<=3&&(r.ishidden="hidden"),r=KISSY.merge(r,i),r.autoAttr=c;var h=t(r);return h},sort:function(e){Array.prototype.sort.call(e,function(){return Math.random()>.5?-1:1})}},{ATTRS:{pluginId:{value:"cloud"},limit:{value:3,setter:function(e){return KISSY.isNumber(e)?e:void 0}},tag:{value:{tmpl:g.tag,sort:!0,length:10}},tag_group:{value:{tmpl:g.tag_group,length:10}},navi:{value:{tmpl:g.navi}},spu:{value:{tmpl:g.spu,length:3}},topbrand:{value:{tmpl:g.topbrand}},qrcode:{value:{tmpl:g.qrcode}},align:{value:!0}}}),a.exports=o});KISSY.add("tbc/search-suggest/6.3.1/plugin/history-magic",["base","dom","ajax","tbc/search-suggest/6.3.1/mods/bts"],function(t,e,a,i){function r(t){r.superclass.constructor.call(this,t||{})}var o=e("base"),u=e("dom"),n=e("ajax"),s=e("tbc/search-suggest/6.3.1/mods/bts");KISSY.extend(r,o,{pluginInitializer:function(t){var e=this,a=t.getPlugin("cloud"),i=500;this.sug=t,e.set("cloudPlugin",a),e.set("caller",t);var r;t.on("afterQueryChange",function(){r&&clearTimeout(r),e.isGetData&&(i=0),r=setTimeout(function(){var i=t.get("menu").get("el");e.getPostData(i,function(t){if(t){var e=u.get(".search-menuitem");a.show(e)}})},i)})},getPostData:function(t,e){var a=this,i=".search-menu-history-key",r=u.query(i,t),o=u.query(".search-menu-extras-history",t),n=[],s=[],c=[],l=a.historyData||{},g=!0;if(!r)return!0;for(var d=0,h=o.length-1;h>=d;d++){var f=u.text(r[d]);n.push(u.attr(o[d],"data-index")),l[f]?l[f].index=d+1:(s.push(f),l[f]={}),c.push(f)}a.historyData=l,0===s.length&&(g=!1);var v,x={text:c,index:n,el:o,result:{content:u.outerHTML(t)}};if(g)v=a.getMagicData(x,function(t){e.call(this,t)});else{var p=a.getLocalData(c);a.render(x,p,function(t){e.call(this,t)})}return v},getLocalData:function(t){for(var e,a={},i=this.historyData,r=0;r<t.length;r++)e=t[r],a[e]=i[e];return a},getMagicData:function(t,e){var a=this,i=t.text,r=a.get("dataUrl"),o=r.replace("{query}",i.join("%01"));-1===o.indexOf("bucketid")&&(o+="&bucketid="+(new s).getBucket()),n.jsonp(o,function(i){a.isGetData=!0,a.render(t,i.magic,e,!0)})},render:function(t,e,a){var i,r,o,n,s=this,c=s.get("cloudPlugin"),l=t.text,g=t.index,d=t.el,h=!1;if(!e)return!0;s.checkCloudBox();for(var f in e){var v=e[f],x=v.index-0;v.data&&(r="_his_"+x,n=KISSY.indexOf(r,g),o=l[n]||f,s.historyData[o]=e[f],n>-1&&u.addClass(d[n],"search-wrap-cloud"),i=c._renderHTML({result:t.result,data:e[f],query:o,index:r,key:o,auto:!1,type:e[f].type||"tag",tagTitle:o,prefix:r,action:s.sug.userConfig&&s.sug.userConfig.action}),u.get("#J_CloudList"+r)&&u.remove("#J_CloudList"+r),u.append(u.create(i),".cloud-box"),1===x&&(h=!0))}a.call(this,h)},checkCloudBox:function(){var t=this.get("caller"),e=t.get("menu").get("el");if(e&&!u.get(".cloud-box")){var a='<div class="search-combobox-menu-footer cloud-footer"><div class="cloud-box" style="height: auto"></div></div>';e.append(a)}},update:function(){}},{ATTRS:{pluginId:{value:"historyMagic"},dataUrl:{value:location.protocol+"//suggest.taobao.com/sug?area=history_magic&q={query}"},cloudPlugin:{value:null}}}),i.exports=r});KISSY.add("tbc/search-suggest/6.3.1/plugin/tab",["node","base","dom","event","combobox"],function(t,a,o,e){function r(t){r.superclass.constructor.call(this,t||{})}var s=a("node"),i=a("base"),c=a("dom"),n=a("event"),l=a("combobox");KISSY.extend(r,i,{pluginInitializer:function(t){this.tabConfig={},this._initPluginEvent.call(this,t)},tabClick:function(t){var a,o,e=this,r=e.get("caller"),i=t.currentTarget,n=c.attr(i,"data-searchtype"),l=c.attr(i,"data-defaultpage"),g=c.attr(i,"data-action"),u=r.comboBox.get("input"),f=c.parent(u,"form"),b=e.get("activeCls"),d=c.get("label",f),m=e.tabConfig;if(r.fire("beforeTabChange",{el:i,labelType:n})===!1)return!1;if(c.removeClass(c.siblings(i),b),c.addClass(i,b),r.tabNode=s.one(i),l&&f.setAttribute("data-defaultpage",l),g&&f.setAttribute("action",g),n){if(o=m[n]||e.getDefCfg(n),!o)return!1;g&&(o.action=g),r.update(o),e.tabConfig&&!e.tabConfig[n]&&e.saveTabConfig(o)}else{var C=r.query||u.val(),h=c.get("a",i);if(h){var p=c.attr(h,"href");p=p.replace("/?","/search?"),p=p+"&q="+C,c.attr(h,"href",p)}}d&&(a=d.getAttribute("data-searchtype-"+n)||"",d.innerHTML=a),t.preventDefault()},_initPluginEvent:function(t){var a=this,o=a.get("activeCls"),e=a.get("node")||t.get("sugConfig").tablist;a.set("caller",t),e&&(n.on(e,"click",a.tabClick,a),s.all(e).each(function(a){var e=s.all(a);e.hasClass(o)&&(t.tabNode=e)}),a.saveTabConfig())},saveTabConfig:function(t){var a,o,e=this,r=e.get("caller"),s=r.get("form");a=r.tabNode.attr("data-searchtype"),o=r.userConfig||{},o.mods=r.get("mods"),o.tab=a,o.action=s.attr("action"),o.defaultpage=s.attr("data-defaultpage"),e.tabConfig||(e.tabConfig={}),e.tabConfig[a]=KISSY.clone(o),t&&t.sugConfig&&t.sugConfig.sourceUrl&&e.tabConfig[a].sugConfig&&(e.tabConfig[a].sugConfig.sourceUrl=t.sugConfig.sourceUrl,e.tabConfig[a].tab=a)},update:function(t){var a,o,e,r=this,s=r.get("caller"),i=s.comboBox,n=t.tab,g=s.configArr[n],u=t.sugConfig,f=i.get("input"),b=c.parent(f,"form");s.configArr=s.configArr||[],o=s.get("dataSourceCfg"),e=o.xhrCfg,e.url=u.sourceUrl,s.__attrVals.mods.sort=t.mods.sort,g||(g=s.configArr[n]=""===e.url?{data:new l.LocalDataSource({data:{},parse:o.parse})}:{data:new l.RemoteDataSource(o)}),a=g.data,i.set("maxItemCount",e.url?10:0),i.set("dataSource",g.data),b&&c.attr(b,"action",t.action),f[0].focus();var d=f.val();d&&i.sendRequest(d)},getDefCfg:function(t){var a;switch(t){case"shop":a={sugConfig:{sourceUrl:location.protocol+"//suggest.taobao.com/sug?area=ssrch&k=1",resultFormat:"",tab:"shop",excludeParam:["q"]},mods:{sort:["history","list"],showExtra:!1},action:location.protocol+"//shopsearch.taobao.com/search",tab:"shop"};break;case"item":a={sugConfig:{sourceUrl:location.protocol+"//suggest.taobao.com/sug?area=c2c&k=1",resultFormat:"",tab:"item",excludeParam:["q"]},mods:{sort:["history","cat","global","list","shop"]},tab:"item",action:location.protocol+"//s.taobao.com/search"};break;case"mall":a={sugConfig:{sourceUrl:location.protocol+"//suggest.taobao.com/sug?area=b2c&k=1",resultFormat:"",tab:"mall",excludeParam:["q"]},mods:{sort:["history","cat","global","list"]},tab:"mall",action:location.protocol+"//list.tmall.com/search_product.htm"};break;default:KISSY.isObject(t)?(a=t,a.sugConfig||(a.sugConfig={})):KISSY.isString(t)&&(a={sugConfig:{sourceUrl:location.protocol+"//suggest.taobao.com/sug?area=c2c&k=1",resultFormat:"",tab:t,excludeParam:["q"]},mods:{sort:["history","list"]},action:null})}return a.sugConfig&&!a.sugConfig.tab&&(a.sugConfig.tab=a.sugConfig.sourceUrl),a}},{ATTRS:{pluginId:{value:"tab"},caller:{value:null}}}),e.exports=r});KISSY.add("tbc/search-suggest/6.3.1/plugin/imgsearch",["node","base","kg/uploader/3.0.6/index","kg/uploader/3.0.6/plugins/auth/auth","kg/uploader/3.0.6/plugins/filedrop/filedrop"],function(e,a,n,o){var r=a("node"),i=a("base"),t=a("kg/uploader/3.0.6/index"),u=a("kg/uploader/3.0.6/plugins/auth/auth"),l=a("kg/uploader/3.0.6/plugins/filedrop/filedrop");o.exports=i.extend({initializer:function(){},pluginInitializer:function(e){var a=this;a.sug=e;var n=a.comboBox=e.comboBox,o=n.get("prefixCls"),r=a.wrap=n.$el.one("."+o+"combobox-input-wrap");r&&r.length>0&&a._renderImgsearch()},_renderImgsearch:function(){var e=this,a=r.one(e.get("query")),n=a.parent("form"),o=r.one(e.get("panel"));e._panelNode=o,e._formNode=n,e._initUploader(),e._bindEvent(),e._bindTabChange()},_initUploader:function(){var e=this,a={max:3,maxSize:5120,allowRepeat:!1,required:!0},n=e.get("authConfig");n=KISSY.merge(a,n);var o=e.get("uploadUrl"),r=e.get("type");"iframe"===r&&(o=o.indexOf("?")>-1?o+"&type=iframe":o+"?type=iframe");var i=new t(e.get("input"),{action:o,type:r}),p=e.get("theme");if(!p)throw new Error("缺少主题");i.theme(p),i.plug(new u(n)).plug(new l),i.on("select",function(){return e.sug.fire("beforeImageSelect")===!1?!1:void("iframe"===e.get("type")&&(document.domain="taobao.com"))}),i.on("success",function(a){return e.sug.fire("beforeImageSuccess",{data:a})===!1?!1:(e._formNode.all("input[name=tfsid]").remove(),e._formNode.all("input[name=app]").remove(),e._formNode.append('<input type="hidden" name="tfsid" value="'+a.result.name+'" />'),e._formNode.append('<input type="hidden" name="app" value="imgsearch" />'),void e._formNode[0].submit())});var d=i.getPlugin("auth");return d?void i.on("error",function(a){e.sug.fire("beforeImageError",{data:a})}):!1},_bindEvent:function(){var e=this,a=e.comboBox.get("prefixCls");e._panelNode.on("mouseenter",function(){e._panelNode.addClass(a+"imgsearch-panel-hover")}),e._panelNode.on("mouseleave",function(){e._panelNode.removeClass(a+"imgsearch-panel-hover")})},_bindTabChange:function(){var e=this;e.sug.on("beforeTabChange",function(a){var n=a.labelType;e.available("item"!==n?!1:!0)})},available:function(e){var a=this;e?a._panelNode.show():a._panelNode.hide()}},{ATTRS:{pluginId:{value:"imgSearch"},panel:{value:"#J_UploaderPanel"},uploadUrl:{value:"//s.taobao.com/image"},input:{value:"#J_IMGSeachUploadBtn"},query:{value:"#q"},authConfig:{value:{}},theme:{value:null},type:{value:"auto"}}})});KISSY.add("tbc/search-suggest/6.3.1/theme/pailitao/index",["node","event","kg/uploader/3.0.3/theme","tbc/search-suggest/6.3.1/theme/pailitao/index.css"],function(e,o,t,r){function s(e){s.superclass.constructor.call(this,e)}var a=o("node"),i=(o("event"),o("kg/uploader/3.0.3/theme"));o("tbc/search-suggest/6.3.1/theme/pailitao/index.css"),e.extend(s,i,{render:function(){var e=this,o=e.get("uploader");o.set("theme",e),e._addThemeCssName(),e._tplFormHtml();var t=e.get("queueTarget");if(!t)throw new Error("拍立淘主题 queueTarget 未设置!");if(e._rootNode=a.all(t),0===e._rootNode.length)throw new Error("拍立淘主题 queueTarget ("+t+") 节点位找到!");e._rootNode.css({outline:"none"}),e._rootNode.on("focusout",function(){e.hideMessage()});var r=e.get("formNode");if(e._formNode=a.all(r),0===e._formNode.length)throw new Error("拍立淘主题 formNode ("+r+") 节点未找到!");var s=e.get("qNode");if(e._qNode=e._formNode.one(s),!e._qNode)throw new Error("拍立淘主题 qNode ("+s+") 节点未找到!");e._bind()},_appendFileDom:function(){return!1},_selectHandler:function(){var e=this;e.showMessage("正在努力上传中...")},_progressHandler:function(){},_errorHandler:function(e){var o=this,t="上传失败";"maxSize"==e.rule&&(e.result={errorMsg:"图片不能大于5M",errorInfo:"请换张图片试试"});var r=e.result.errorMsg||"请重新上传试试",s=e.result.errorInfo;o.showMessage(t,r,s)},_completeHandler:function(e){var o=this;0!==e.result.status&&o.showMessage("图片上传成功","正在努力跳转,请稍候...")},showMessage:function(o,t,r){var s=this,a=s.get("fileTpl"),i=e.substitute(a,{title:o,msg:t||"",info:r||""});s._rootNode.html(i),s._rootNode.attr("tabindex",-1),s._rootNode.css("display","block"),s._rootNode[0].focus()},hideMessage:function(){var e=this;e._rootNode.css("display","none")}},{ATTRS:{formNode:{value:"#J_SearchForm"},qNode:{value:"#q"},name:{value:"imgseach-pailitao-theme"},fileTpl:{value:'<div class="pailitao-message"><div class="pailitao-message-content"><p class="title" id="J_pailitaoMessageTitle">{title}</p><p class="msg">{msg}</p><p class="info">{info}</p></div></div>'},allowExts:{value:"jpg,png,gif,jpeg"},authMsg:{value:{max:"每次最多上传{max}个文件！",maxSize:"图片不能大于5M",widthHeight:"图片宽高需大于200",required:"至少上传一个文件！",allowExts:"不支持{ext}格式！",allowRepeat:"该文件已经存在！"}}}}),r.exports=s});